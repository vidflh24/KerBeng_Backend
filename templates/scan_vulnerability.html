{% extends 'base.html' %}
{% block title %}Scan Vulnerability - AutoPentest{% endblock %}

{% block content %}
<div x-data="scanForm()" class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
  
  <!-- Header -->
  <div class="mb-6">
    <div class="flex items-center gap-3 mb-2">
      <i data-lucide="scan" class="w-7 h-7 text-Primary-500"></i>
      <h1 class="text-2xl sm:text-3xl font-bold text-Primary-500">Scan Vulnerability</h1>
    </div>
    <p class="text-gray-600 text-sm">
      Scan your target to detect vulnerabilities and available CVE exploits
    </p>
  </div>

  <!-- Main Card -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 sm:p-8">
    
    <!-- Project Information -->
    <div class="mb-6">
      <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <i data-lucide="info" class="w-5 h-5 text-Primary-500"></i>
        Project Information
      </h2>
      
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            Project Name <span class="text-red-500">*</span>
          </label>
          <input 
            x-model="projectName" 
            type="text" 
            required
            placeholder="My Pentest Project"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-Primary-200 text-sm">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">
            Username
          </label>
          <input 
            x-model="username" 
            type="text"
            placeholder="Your name"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-Primary-200 text-sm">
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Description
        </label>
        <textarea 
          x-model="description" 
          rows="2"
          placeholder="Brief description of this scan..."
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-Primary-200 text-sm resize-none"></textarea>
      </div>
    </div>

    <div class="border-t border-gray-200 my-6"></div>

    <!-- Scan Targets -->
    <div class="mb-6">
      <h2 class="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
        <i data-lucide="target" class="w-5 h-5 text-Primary-500"></i>
        Scan Targets
      </h2>

      <!-- Target 1 -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">
          Target IP or URL <span class="text-red-500">*</span>
        </label>
        <input 
          x-model="targets[0]" 
          type="text" 
          required
          placeholder="192.168.1.10 or example.com"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-Primary-200 text-sm">
      </div>

      <!-- Target 2 (Optional) -->
      <div>
        <div class="flex items-center justify-between mb-2">
          <label class="block text-sm font-medium text-gray-700">
            Target 2 (Optional)
          </label>
          <label class="flex items-center gap-2 cursor-pointer">
            <input 
              type="checkbox" 
              x-model="enableTarget2"
              class="w-4 h-4 text-Primary-500 rounded focus:ring-Primary-200">
            <span class="text-sm text-gray-600">Enable second target</span>
          </label>
        </div>
        
        <input 
          x-show="enableTarget2"
          x-transition
          x-model="targets[1]" 
          type="text"
          :required="enableTarget2"
          placeholder="192.168.1.20 or example2.com"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-Primary-200 text-sm">
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="flex flex-col sm:flex-row gap-3">
      <button 
        @click="startScan"
        :disabled="scanning"
        class="flex-1 bg-Primary-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-Primary-200 disabled:opacity-60 disabled:cursor-not-allowed flex items-center justify-center gap-2 transition-all">
        <i :data-lucide="scanning ? 'loader-2' : 'scan'" :class="{'animate-spin': scanning}" class="w-5 h-5"></i>
        <span x-text="scanning ? 'Scanning...' : 'Start Scan'"></span>
      </button>

      <button 
        @click="resetForm"
        :disabled="scanning"
        type="button"
        class="flex-none bg-white border border-gray-300 rounded-lg px-6 py-3 text-sm text-gray-700 hover:bg-gray-50 disabled:opacity-60 transition-all">
        Clear
      </button>
    </div>

    <!-- Status Message -->
    <div 
      x-show="statusMessage"
      x-transition
      :class="{
        'bg-green-50 text-green-600 border-green-200': statusType === 'success',
        'bg-red-50 text-red-600 border-red-200': statusType === 'error',
        'bg-blue-50 text-blue-600 border-blue-200': statusType === 'info'
      }"
      class="mt-4 flex items-center gap-3 px-4 py-3 rounded-lg border">
      <i :data-lucide="statusType === 'success' ? 'check-circle' : statusType === 'error' ? 'x-circle' : 'info'" class="w-5 h-5 flex-shrink-0"></i>
      <span class="text-sm font-medium" x-text="statusMessage"></span>
    </div>

  </div>

  <!-- Info Box -->
  <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-5">
    <div class="flex items-start gap-3">
      <i data-lucide="info" class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"></i>
      <div class="text-sm text-blue-800">
        <p class="font-semibold mb-2">How vulnerability scanning works:</p>
        <ul class="space-y-1 list-disc list-inside">
          <li>Backend will scan the target for known vulnerabilities</li>
          <li>Available CVE exploits will be detected automatically</li>
          <li>You can scan up to 2 targets simultaneously</li>
          <li>Scan results will show which exploits can be used</li>
        </ul>
      </div>
    </div>
  </div>

</div>

<script>
function scanForm() {
  return {
    // Form data
    projectName: '',
    username: '{{ session.username if session.username else "" }}',
    description: '',
    targets: ['', ''],
    enableTarget2: false,
    
    // Status
    scanning: false,
    statusMessage: '',
    statusType: 'info',

    // Start scan
    async startScan() {
      // Validasi
      if (!this.projectName.trim()) {
        this.showStatus('Project name is required', 'error');
        return;
      }

      if (!this.targets[0].trim()) {
        this.showStatus('Target 1 is required', 'error');
        return;
      }

      if (this.enableTarget2 && !this.targets[1].trim()) {
        this.showStatus('Please enter Target 2 or disable it', 'error');
        return;
      }

      // Prepare targets
      const targetsToScan = [this.targets[0].trim()];
      if (this.enableTarget2 && this.targets[1].trim()) {
        targetsToScan.push(this.targets[1].trim());
      }

      // Start scanning
      this.scanning = true;
      this.showStatus('Scanning target(s) for vulnerabilities...', 'info');

      try {
        // ðŸ”Œ BACKEND INTEGRATION POINT 1: Scan API
        // TODO: Ganti dengan endpoint backend yang sebenarnya
        const response = await fetch("{{ url_for('api_scan_vulnerability') }}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            project_name: this.projectName,
            username: this.username,
            description: this.description,
            targets: targetsToScan
          })
        });

        const data = await response.json();

        if (response.ok) {
          // Success - redirect ke halaman select CVE dengan scan results
          this.showStatus('Scan completed! Redirecting...', 'success');
          
          // Simpan data ke sessionStorage untuk halaman berikutnya
          sessionStorage.setItem('scan_results', JSON.stringify({
            project_name: this.projectName,
            username: this.username,
            description: this.description,
            targets: targetsToScan,
            scan_results: data.results || []  // ðŸ”Œ Backend return scan results
          }));

          // Redirect ke halaman select CVE
          setTimeout(() => {
            window.location.href = "{{ url_for('select_cve') }}";
          }, 1500);
        } else {
          this.showStatus(data.message || 'Scan failed', 'error');
        }
      } catch (error) {
        this.showStatus('Network error: ' + error.message, 'error');
      } finally {
        this.scanning = false;
        setTimeout(() => lucide.createIcons(), 100);
      }
    },

    // Reset form
    resetForm() {
      this.projectName = '';
      this.username = '{{ session.username if session.username else "" }}';
      this.description = '';
      this.targets = ['', ''];
      this.enableTarget2 = false;
      this.statusMessage = '';
      setTimeout(() => lucide.createIcons(), 100);
    },

    // Show status
    showStatus(message, type) {
      this.statusMessage = message;
      this.statusType = type;
      setTimeout(() => lucide.createIcons(), 100);
      
      if (type !== 'error') {
        setTimeout(() => {
          this.statusMessage = '';
        }, 5000);
      }
    }
  }
}
</script>
{% endblock %}