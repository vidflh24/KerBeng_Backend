{% extends 'base.html' %}
{% block title %}Create Project - AutoPentest{% endblock %}

{% block content %}
<!-- Section: Project Header -->
<div class="flex items-center justify-between mb-6">
  <h1 class="text-2xl font-bold text-Primary-500 flex items-center gap-2">
    <i data-lucide="folder-open" class="w-6 h-6"></i>
    Projects
  </h1>
</div>

<div class="max-w-5xl mx-auto" x-data="projectForm()">
  <div class="bg-white rounded-lg shadow-md p-6">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <i data-lucide="folder-plus" class="w-7 h-7 text-Primary-500"></i>
        <h1 class="text-2xl font-roboto font-bold text-Primary-500">Create Pentest Project</h1>
      </div>
      <div class="text-sm text-gray-500">
        You can run up to 2 pentests simultaneously
      </div>
    </div>

    <!-- Form -->
    <form @submit.prevent="submitForm" @input.debounce.700="debouncedSave()" class="space-y-6" autocomplete="off">

      <!-- Project Info Section -->
      <div class="border-b pb-6">
        <h3 class="text-lg font-semibold text-Primary-500 mb-4 flex items-center gap-2">
          <i data-lucide="info" class="w-5 h-5"></i>
          Project Information
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Project Name *
            </label>
            <input x-model="projectName" type="text" required
              class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-Primary-200"
              placeholder="My Pentest Project">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Username
            </label>
            <input x-model="username" type="text"
              class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-Primary-200"
              placeholder="Your name">
          </div>
        </div>

        <div class="mt-4">
          <label class="block text-sm font-medium text-gray-700 mb-1">
            Description
          </label>
          <textarea x-model="description" rows="3"
            class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-Primary-200"
            placeholder="Describe your project..."></textarea>
        </div>
      </div>

      <!-- Target 1 Section -->
      <div class="border-2 border-Primary-200 rounded-lg p-4 bg-Primary-100/30">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-Primary-500 flex items-center gap-2">
            <i data-lucide="target" class="w-5 h-5"></i>
            Target 1 *
          </h3>
          <span class="text-xs bg-blue-500 text-white px-3 py-1 rounded-full font-semibold">Required</span>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Target IP or URL *
            </label>
            <input x-model="targets[0].target_ip" type="text" required
              class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-Primary-200"
              placeholder="192.168.1.10">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              CVE Module *
            </label>
            <select x-model="targets[0].cve_module" required
              class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-Primary-200">
              <option value="">-- Select CVE --</option>
              <option value="CVE12_2122">CVE-2012-2122 (MySQL Auth Bypass)</option>
              <option value="CVE22_46169">CVE-2022-46169 (Cacti RCE)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Target 2 Section (Optional) -->
      <div class="border-2 border-gray-300 rounded-lg p-4" :class="enableTarget2 ? 'bg-blue-50' : 'bg-gray-50'">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold flex items-center gap-2"
            :class="enableTarget2 ? 'text-Primary-500' : 'text-gray-500'">
            <i data-lucide="target" class="w-5 h-5"></i>
            Target 2 (Optional)
          </h3>
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" x-model="enableTarget2"
              class="w-4 h-4 text-Primary-500 rounded focus:ring-Primary-200">
            <span class="text-sm font-medium" :class="enableTarget2 ? 'text-Primary-500' : 'text-gray-600'">
              Enable second target
            </span>
          </label>
        </div>

        <div x-show="enableTarget2" x-transition:enter="transition ease-out duration-300"
          x-transition:enter-start="opacity-0 transform scale-95"
          x-transition:enter-end="opacity-100 transform scale-100" class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              Target IP or URL
            </label>
            <input x-model="targets[1].target_ip" type="text" :required="enableTarget2"
              class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-Primary-200"
              placeholder="192.168.1.20">
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">
              CVE Module
            </label>
            <select x-model="targets[1].cve_module" :required="enableTarget2"
              class="w-full border rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-Primary-200">
              <option value="">-- Select CVE --</option>
              <option value="CVE12_2122">CVE-2012-2122 (MySQL Auth Bypass)</option>
              <option value="CVE22_46169">CVE-2022-46169 (Cacti RCE)</option>
            </select>
          </div>
        </div>

        <p x-show="!enableTarget2" class="text-sm text-gray-500 mt-2 flex items-center gap-2">
          <i data-lucide="info" class="w-4 h-4"></i>
          Check the box above to run a second pentest simultaneously
        </p>
      </div>

      <!-- Action Buttons -->
      <div class="flex items-center gap-3 pt-4 border-t">
        <button type="submit" :disabled="submitting"
          class="bg-Primary-500 text-white px-6 py-3 rounded-md font-medium hover:bg-Primary-200 disabled:opacity-60 disabled:cursor-not-allowed flex items-center gap-2 transition-all">
          <i :data-lucide="submitting ? 'loader-2' : 'play'" :class="{'animate-spin': submitting}" class="w-4 h-4"></i>
          <span x-text="submitting ? 'Starting...' : 'Start Pentest'"></span>
        </button>

        <button type="button" @click="resetForm" :disabled="submitting"
          class="bg-white border border-gray-300 rounded-md px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 disabled:opacity-60 disabled:cursor-not-allowed transition-all">
          <i data-lucide="x" class="w-4 h-4 inline-block mr-1"></i>
          Clear Form
        </button>

        <!-- Status Message -->
        <div x-show="statusMessage" x-transition :class="{
            'text-green-600': statusType === 'success',
            'text-red-600': statusType === 'error',
            'text-blue-600': statusType === 'info'
          }" class="ml-auto text-sm font-medium flex items-center gap-2">
          <i :data-lucide="statusType === 'success' ? 'check-circle' : statusType === 'error' ? 'x-circle' : 'info'"
            class="w-4 h-4"></i>
          <span x-text="statusMessage"></span>
        </div>
      </div>
    </form>

    <!-- Info Box -->
    <div class="mt-6 bg-blue-50 border-l-4 border-blue-500 rounded-lg p-4">
      <div class="flex gap-3">
        <i data-lucide="lightbulb" class="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"></i>
        <div class="text-sm text-blue-800">
          <p class="font-semibold mb-2">ðŸ’¡ Tips for running multiple pentests:</p>
          <ul class="list-disc list-inside space-y-1 ml-2">
            <li>Both pentests will run simultaneously in the background</li>
            <li>You can monitor real-time progress in the Dashboard</li>
            <li>Each target will be tracked separately with individual progress bars</li>
            <li>Results will be saved individually for each target</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function projectForm() {
    // ambil data dari server (via Jinja)
    const serverData = {{ form_data | tojson | safe
  }};

  function safeGet(obj, key, fallback) {
    return (obj && obj[key] !== undefined) ? obj[key] : fallback;
  }

  // debounce helper
  function debounce(fn, wait) {
    let t;
    return function (...args) {
      clearTimeout(t);
      t = setTimeout(() => fn.apply(this, args), wait);
    };
  }

  return {
    // Form data (prefill)
    projectName: safeGet(serverData, 'project_name', 'Project Test'),
    username: safeGet(serverData, 'username', ''),
    description: safeGet(serverData, 'description', ''),
    enableTarget2: safeGet(serverData, 'enableTarget2', false),
    targets: (function () {
      const t = safeGet(serverData, 'targets', []);
      const first = t[0] || { target_ip: '', cve_module: '' };
      const second = t[1] || { target_ip: '', cve_module: '' };
      if (typeof first === 'string') {
        return [{ target_ip: first, cve_module: '' }, second];
      }
      return [first, second];
    })(),

    // Status
    submitting: false,
    statusMessage: '',
    statusType: 'info',

    // internal: debounced saveDraft
    debouncedSave: null,

    init() {
      // Inisialisasi debounced function saat Alpine inisialisasi
      this.debouncedSave = debounce(() => this.saveDraft(), 700);

      // beforeunload: kirim draft via Beacon jika tersedia
      window.addEventListener('beforeunload', (e) => {
        try {
          this.sendDraftOnUnload();
        } catch (err) {
          // ignore
        }
      });

      // optional: juga kirim saat pagehide (untuk mobile)
      window.addEventListener('pagehide', () => {
        try {
          this.sendDraftOnUnload();
        } catch (err) { }
      });
    },

    // Save draft via fetch (async)
    async saveDraft() {
      const payload = {
        project_name: this.projectName,
        username: this.username,
        description: this.description,
        enableTarget2: !!this.enableTarget2,
        targets: (this.enableTarget2 ? [this.targets[0], this.targets[1]] : [this.targets[0]]).map(t => ({
          target_ip: t.target_ip || '',
          cve_module: t.cve_module || ''
        }))
      };

      try {
        await fetch("{{ url_for('api_save_scan_draft') }}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          keepalive: true  // membantu di beberapa browser untuk request saat unload
        });
        // optional small feedback (non-intrusive)
        // this.showStatus('Draft saved', 'info');
      } catch (err) {
        // silent fail; jangan ganggu UX
        console.warn('Failed to save draft', err);
      }
    },

    // Called by @input.debounce on the form
    debouncedSave() {
      // will be replaced with actual debounced function in init()
    },

    // Send draft on unload using sendBeacon (better for unload)
    sendDraftOnUnload() {
      const payload = {
        project_name: this.projectName,
        username: this.username,
        description: this.description,
        enableTarget2: !!this.enableTarget2,
        targets: (this.enableTarget2 ? [this.targets[0], this.targets[1]] : [this.targets[0]]).map(t => ({
          target_ip: t.target_ip || '',
          cve_module: t.cve_module || ''
        }))
      };

      const url = "{{ url_for('api_save_scan_draft') }}";
      const body = JSON.stringify(payload);

      // coba sendBeacon dulu
      if (navigator.sendBeacon) {
        try {
          const blob = new Blob([body], { type: 'application/json' });
          navigator.sendBeacon(url, blob);
          return;
        } catch (err) {
          // fallback ke fetch below
        }
      }

      // fallback synchronous-ish fetch using keepalive
      try {
        fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body,
          keepalive: true
        });
      } catch (err) {
        // ignore
      }
    },

    // Submit form: tetap simpan draft dulu (opsional) lalu kirim scan
    async submitForm() {
      // Validasi (sama seperti sebelumnya)
      if (!this.projectName.trim()) {
        this.showStatus('Project name is required', 'error');
        return;
      }
      if (!this.targets[0].target_ip || !this.targets[0].cve_module) {
        this.showStatus('Target 1 is required', 'error');
        return;
      }
      if (this.enableTarget2) {
        if (!this.targets[1].target_ip || !this.targets[1].cve_module) {
          this.showStatus('Please fill Target 2 or disable it', 'error');
          return;
        }
      }

      const targetsToSubmit = [this.targets[0]];
      if (this.enableTarget2) targetsToSubmit.push(this.targets[1]);

      // Simpan draft dulu (best-effort)
      try {
        await this.saveDraft();
      } catch (err) { }

      // Submit ke API scan
      this.submitting = true;
      this.showStatus('Starting pentest(s)...', 'info');

      try {
        const response = await fetch("{{ url_for('api_scan_vulnerability') }}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            project_name: this.projectName,
            username: this.username,
            description: this.description,
            targets: targetsToSubmit
          })
        });

        const data = await response.json();

        if (response.ok) {
          this.showStatus(data.message, 'success');
          setTimeout(() => {
            window.location.href = "{{ url_for('select_cve') }}";
          }, 600);
        } else {
          this.showStatus(data.message || 'Failed to start pentest', 'error');
        }
      } catch (error) {
        this.showStatus('Network error: ' + error.message, 'error');
      } finally {
        this.submitting = false;
        setTimeout(() => lucide.createIcons(), 100);
      }
    },

    resetForm() {
      this.projectName = '';
      this.username = '';
      this.description = '';
      this.enableTarget2 = false;
      this.targets = [
        { target_ip: '', cve_module: '' },
        { target_ip: '', cve_module: '' }
      ];
      this.statusMessage = '';
      setTimeout(() => lucide.createIcons(), 100);
    },

    showStatus(message, type) {
      this.statusMessage = message;
      this.statusType = type;
      setTimeout(() => lucide.createIcons(), 100);
      if (type !== 'error') {
        setTimeout(() => { this.statusMessage = ''; }, 5000);
      }
    }
  }
}
</script>


{% endblock %}