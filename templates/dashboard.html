{% extends "base.html" %}
{% block title %}Dashboard - AutoPentest{% endblock %}
{% block content %}

<!-- Section: Dashboard Header -->
<div class="flex items-center justify-between mb-6">
  <h1 class="text-2xl font-bold text-Primary-500 flex items-center gap-2">
    <i data-lucide="layout-dashboard" class="w-6 h-6"></i>
    Dashboard
  </h1>
  <a href="{{ url_for('scan_vulnerability') }}"
    class="bg-Primary-500 hover:bg-Primary-200 text-white font-medium px-4 py-2 rounded-lg flex items-center gap-2 transition">
    <i data-lucide="plus-circle" class="w-5 h-5"></i>
    Scan Vulnerability
  </a>
</div>

<!-- Section: Overview Cards -->
<div id="overview-cards" hx-get="{{ url_for('htmx_stats') }}" hx-trigger="load, every 10s" hx-swap="morphdom:outerHTML"
  hx-target="#overview-cards" class="grid grid-cols-1 md:grid-cols-3 gap-5 mb-8 will-change-transform">

  <!-- Placeholder (initial load) -->
  <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-200 animate-pulse">
    <div class="h-4 bg-gray-200 rounded w-1/2 mb-2"></div>
    <div class="h-8 bg-gray-200 rounded w-1/3 mb-2"></div>
    <div class="h-3 bg-gray-200 rounded w-2/3"></div>
  </div>
  <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-200 animate-pulse">
    <div class="h-4 bg-gray-200 rounded w-1/2 mb-2"></div>
    <div class="h-8 bg-gray-200 rounded w-1/3 mb-2"></div>
    <div class="h-3 bg-gray-200 rounded w-2/3"></div>
  </div>
  <div class="bg-white rounded-xl p-5 shadow-sm border border-gray-200 animate-pulse">
    <div class="h-4 bg-gray-200 rounded w-1/2 mb-2"></div>
    <div class="h-8 bg-gray-200 rounded w-1/3 mb-2"></div>
    <div class="h-3 bg-gray-200 rounded w-2/3"></div>
  </div>
</div>

<!-- Section: Projects Table -->
<div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-5 mb-8">
  <div class="flex items-center justify-between mb-4">
    <h2 class="text-lg font-semibold text-Primary-500 flex items-center gap-2">
      <i data-lucide="folder-open" class="w-5 h-5"></i>
      Recent Projects
    </h2>
    <div class="flex items-center gap-3" hx-preserve="true">
      <div class="relative">
        <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute left-3 top-2.5"></i>
        <input type="text" placeholder="Search projects..." name="search" hx-get="{{ url_for('htmx_jobs_table') }}"
          hx-trigger="keyup changed delay:300ms" hx-target="#projects-table" hx-include="[name='search']"
          hx-push-url="false"
          class="pl-9 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-Primary-200 w-60"
          value="{{ request.args.get('search', '') }}" data-sort-by="{{ request.args.get('sort_by', 'created_at') }}"
          data-order="{{ request.args.get('order', 'desc') }}" />
      </div>
    </div>
  </div>

  <div id="projects-table" hx-get="{{ url_for('htmx_jobs_table') }}" hx-trigger="revealed" hx-swap="morphdom:outerHTML"
    hx-target="#projects-table" hx-vals='{
    "search": "{{ request.args.get("search", "") }}",
    "sort_by": "{{ request.args.get("sort_by", "created_at") }}",
    "order": "{{ request.args.get("order", "desc") }}"
  }' hx-include="[name='search']" class="transition-opacity duration-300 ease-in-out" data-sort-by="created_at"
    data-order="desc">
    <!-- Placeholder saat loading -->
    <div class="space-y-3 animate-pulse">
      <div class="h-10 bg-gray-200 rounded"></div>
      <div class="h-10 bg-gray-100 rounded"></div>
      <div class="h-10 bg-gray-100 rounded"></div>
    </div>
  </div>
</div>


<!-- Section: Progress Pentest -->
<div class="bg-white shadow-sm rounded-xl border border-gray-100 p-6">
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-2">
      <i data-lucide="activity" class="w-5 h-5 text-Primary-500"></i>
      <h3 class="text-lg font-semibold text-Primary-500">
        Running Pentests</h3>
    </div>
    <div class="flex items-center gap-2" hx-preserve="true">
      <div class="relative">
        <i data-lucide="search" class="w-4 h-4 text-gray-400 absolute left-3 top-2.5"></i>
        <input type="text" placeholder="Search running pentests..." name="progress_search"
          hx-get="{{ url_for('htmx_progress_table') }}" hx-trigger="keyup changed delay:300ms"
          hx-target="#progress-table" hx-include="[name='progress_search']" hx-push-url="false"
          class="pl-9 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-Primary-200 w-60"
          value="{{ request.args.get('progress_search', '') }}" />
      </div>
    </div>
  </div>

  <div id="progress-table" hx-get="{{ url_for('htmx_progress_table') }}" hx-trigger="revealed"
    hx-swap="morphdom:outerHTML" hx-target="#progress-table" class="transition-opacity duration-300 ease-in-out">

    <!-- Placeholder saat loading -->
    <div class="space-y-3 animate-pulse">
      <div class="h-10 bg-gray-200 rounded"></div>
      <div class="h-10 bg-gray-100 rounded"></div>
    </div>
  </div>
</div>

<div id="alert-container" class="fixed top-6 right-6 z-[9999] space-y-2"></div>

<script>
  // --- 1️⃣ Inisialisasi lucide icons ---
  document.addEventListener("DOMContentLoaded", () => lucide.createIcons());
  document.addEventListener("htmx:afterSwap", () => lucide.createIcons());

  // --- 2️⃣ Tempel alert global kalau server kirim alert.html ---
  document.body.addEventListener("htmx:afterRequest", (evt) => {
    const xhr = evt.detail.xhr;
    if (xhr && xhr.responseText.includes('id="alert-box"')) {
      const alertContainer = document.getElementById("alert-container");
      if (alertContainer) {
        alertContainer.innerHTML = xhr.responseText;
        lucide.createIcons();
      }
    }
  });

  // --- Auto-refresh untuk Projects Table ---
  window.startAutoRefreshProjects = function () {
    const table = document.getElementById("projects-table");
    if (!table) return;

    // pastikan timer berbeda
    if (window._autoRefreshTimerProjects) clearInterval(window._autoRefreshTimerProjects);

    window._autoRefreshTimerProjects = setInterval(() => {
      const sortBy = table.dataset.sortBy || 'created_at';
      const order = table.dataset.order || 'desc';
      const search = document.querySelector("input[name='search']")?.value || '';

      htmx.ajax('GET', `/htmx/jobs-table?sort_by=${sortBy}&order=${order}&search=${encodeURIComponent(search)}`, {
        target: '#projects-table',
        swap: 'innerHTML'
      });
    }, 7000);
  };

  // --- Auto-refresh untuk Progress Table ---
  window.startAutoRefreshProgress = function () {
    const table = document.getElementById("progress-table");
    if (!table) return;

    if (window._autoRefreshTimerProgress) clearInterval(window._autoRefreshTimerProgress);

    window._autoRefreshTimerProgress = setInterval(() => {
      const sortBy = table.dataset.sortBy || 'created_at';
      const order = table.dataset.order || 'desc';
      const search = document.querySelector("input[name='search']")?.value || '';

      htmx.ajax('GET', `/htmx/progress-table?sort_by=${sortBy}&order=${order}&search=${encodeURIComponent(search)}`, {
        target: '#progress-table',
        swap: 'innerHTML'
      });
    }, 7000);
  };

  window.stopAutoRefresh = function () {
    if (window._autoRefreshTimer) {
      clearInterval(window._autoRefreshTimer);
      window._autoRefreshTimer = null;
    }
  };

  // --- 4️⃣ Jalankan auto-refresh tergantung search ---
  document.addEventListener("DOMContentLoaded", () => {
    const searchInput = document.querySelector("input[name='search']");
    if (!searchInput) return;

    // Mulai auto-refresh hanya kalau kolom kosong
    if (searchInput.value.trim() === "") {
      startAutoRefreshProjects();
      startAutoRefreshProgress();
    }

    // Pause kalau user mengetik
    searchInput.addEventListener("input", () => {
      if (searchInput.value.trim() !== "") {
        window.stopAutoRefresh();
      } else {
        startAutoRefreshProjects();
        startAutoRefreshProgress();

      }
    });
  });

  // --- 5️⃣ Tambahkan konfigurasi HTMX untuk sort & search ---
  document.body.addEventListener('htmx:configRequest', (evt) => {
    const projectTable = document.getElementById('projects-table');
    const progressTable = document.getElementById('progress-table');

    if (evt.detail.path.includes('htmx_jobs_table') && projectTable) {
      evt.detail.parameters.sort_by = projectTable.dataset.sortBy || 'created_at';
      evt.detail.parameters.order = projectTable.dataset.order || 'desc';
    }

    if (evt.detail.path.includes('htmx_progress_table') && progressTable) {
      evt.detail.parameters.sort_by = progressTable.dataset.sortBy || 'created_at';
      evt.detail.parameters.order = progressTable.dataset.order || 'desc';

      const searchInput = document.querySelector('[name="progress_search"]');
      if (searchInput) {
        evt.detail.parameters.progress_search = searchInput.value || '';
      }
    }
  });

  document.addEventListener("htmx:afterSwap", () => lucide.createIcons());
</script>

{% block scripts %}
{{ super() }}
<script src="https://unpkg.com/htmx.org/dist/ext/morphdom-swap.js"></script>
<script>
  document.body.addEventListener("htmx:afterSwap", () => lucide.createIcons());
</script>
{% endblock %}

{% endblock %}