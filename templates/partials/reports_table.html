<div x-data x-init="lucide.createIcons()">
    {% if jobs %}
    <div class="overflow-x-auto rounded-lg border border-gray-100">
        <table class="min-w-full table-fixed divide-y divide-gray-200 text-sm">
            <thead class="bg-Primary-100 text-Primary-500 uppercase text-xs font-semibold">
                <tr>
                    <!-- Kolom: Project Name -->
                    <th class="w-2/5 px-4 py-3 text-left cursor-pointer select-none"
                        hx-get="{{ url_for('htmx_jobs_table') }}" hx-include="[name='search']"
                        hx-target="#projects-table" hx-swap="morphdom:outerHTML" hx-vals='{
                "sort_by": "project_name",
                "order": "{{ 'asc' if sort_by !='project_name' or order == 'desc' else 'desc' }}", 
                "search": "{{ request.args.get('search', '') }}" }' 
                onclick="
                const table = document.getElementById('projects-table');
                table.dataset.sortBy = 'project_name';
                table.dataset.order = '{{ 'asc' if sort_by != 'project_name' or order == 'desc' else 'desc' }}';
              ">
                        Project Name
                        {% if sort_by == "project_name" %}
                        {% if order == "asc" %}
                        <i data-lucide="arrow-up" class="inline w-3 h-3 ml-1 text-Primary-500"></i>
                        {% else %}
                        <i data-lucide="arrow-down" class="inline w-3 h-3 ml-1 text-Primary-500"></i>
                        {% endif %}
                        {% else %}
                        <i data-lucide="arrow-up-down" class="inline w-3 h-3 ml-1 opacity-60"></i>
                        {% endif %}
                    </th>

                    <!-- Kolom: CVE Module -->
                    <th class="px-4 py-3 text-left cursor-pointer select-none" hx-get="{{ url_for('htmx_jobs_table') }}"
                        hx-target="#projects-table" hx-swap="morphdom:outerHTML" hx-vals='{
                "sort_by": "cve_module",
                "order": "{{ ' asc' if sort_by !='cve_module' or order=='desc' else 'desc' }}" }'>
                        CVE Module
                        {% if sort_by == "cve_module" %}
                        {% if order == "asc" %}
                        <i data-lucide="arrow-up" class="inline w-3 h-3 ml-1 text-Primary-500"></i>
                        {% else %}
                        <i data-lucide="arrow-down" class="inline w-3 h-3 ml-1 text-Primary-500"></i>
                        {% endif %}
                        {% else %}
                        <i data-lucide="arrow-up-down" class="inline w-3 h-3 ml-1 opacity-60"></i>
                        {% endif %}
                    </th>

                    <!-- Kolom: Status -->
                    <th class="px-4 py-3 text-left cursor-pointer select-none" hx-get="{{ url_for('htmx_jobs_table') }}"
                        hx-target="#projects-table" hx-swap="morphdom:outerHTML" hx-vals='{
                "sort_by": "status",
                "order": "{{ ' asc' if sort_by !='status' or order=='desc' else 'desc' }}" }'>
                        Status
                        {% if sort_by == "status" %}
                        {% if order == "asc" %}
                        <i data-lucide="arrow-up" class="inline w-3 h-3 ml-1 text-Primary-500"></i>
                        {% else %}
                        <i data-lucide="arrow-down" class="inline w-3 h-3 ml-1 text-Primary-500"></i>
                        {% endif %}
                        {% else %}
                        <i data-lucide="arrow-up-down" class="inline w-3 h-3 ml-1 opacity-60"></i>
                        {% endif %}
                    </th>

                    <!-- Kolom: Last Run -->
                    <th class="px-4 py-3 text-left cursor-pointer select-none" hx-get="{{ url_for('htmx_jobs_table') }}"
                        hx-target="#projects-table" hx-swap="morphdom:outerHTML" hx-vals='{
                "sort_by": "created_at",
                "order": "{{ ' asc' if sort_by !='created_at' or order=='desc' else 'desc' }}" }'>
                        Last Run
                        {% if sort_by == "created_at" %}
                        {% if order == "asc" %}
                        <i data-lucide="arrow-up" class="inline w-3 h-3 ml-1 text-Primary-500"></i>
                        {% else %}
                        <i data-lucide="arrow-down" class="inline w-3 h-3 ml-1 text-Primary-500"></i>
                        {% endif %}
                        {% else %}
                        <i data-lucide="arrow-up-down" class="inline w-3 h-3 ml-1 opacity-60"></i>
                        {% endif %}
                    </th>

                    <th class="px-4 py-3 text-left">Action</th>
                </tr>
            </thead>

            <tbody class="bg-white divide-y divide-gray-100">
                {% for job in jobs %}
                <tr class="hover:bg-Primary-100/30 transition-colors">
                    <!-- Project Info -->
                    <td class="px-4 py-3">
                        <div class="font-medium text-gray-900">{{ job.project_name }}</div>
                        <div class="text-xs text-gray-500 mt-1 flex gap-2">
                            <span class="inline-flex items-center gap-1">
                                <i data-lucide="user" class="w-3 h-3"></i> {{ job.username }}
                            </span>
                            <span>â€¢</span>
                            <span class="inline-flex items-center gap-1">
                                <i data-lucide="server" class="w-3 h-3"></i> {{ job.target_ip }}
                            </span>
                        </div>
                    </td>

                    <!-- CVE -->
                    <td class="px-4 py-3 text-gray-700">{{ job.cve_module }}</td>

                    <!-- Status -->
                    <td class="px-4 py-3">
                        {% if job.status == 'running' %}
                        <span
                            class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-700">
                            <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Running
                        </span>
                        {% elif job.status == 'completed' %}
                        <span
                            class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-700">
                            <i data-lucide="check-circle" class="w-4 h-4"></i> Completed
                        </span>
                        {% elif job.status == 'failed' %}
                        <span
                            class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-700">
                            <i data-lucide="x-circle" class="w-4 h-4"></i> Failed
                        </span>
                        {% elif job.status == 'cancelled' %}
                        <span
                            class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-700">
                            <i data-lucide="x" class="w-4 h-4"></i> Cancelled
                        </span>
                        {% else %}
                        <span
                            class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium bg-gray-50 text-gray-400">
                            Unknown
                        </span>
                        {% endif %}
                    </td>

                    <!-- Last Run -->
                    <td class="px-4 py-3 text-gray-600">
                        <span class="inline-flex items-center gap-2">
                            <i data-lucide="calendar" class="w-4 h-4 text-gray-400"></i>
                            {{ job.created_at }}
                        </span>
                    </td>

                    <!-- Actions -->
                    <td class="px-4 py-3 flex items-center gap-2 justify-center">
                        <!-- Delete -->
                        <button class="p-1.5 rounded hover:bg-red-100 text-red-500"
                            hx-get="/partials/confirm-delete-modal" hx-target="body" hx-swap="beforeend"
                            hx-vals='{"job_id": "{{ job.job_id }}", "project_name": "{{ job.project_name }}"}'
                            title="Delete">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>

                        <!-- Download -->
                        {% if job.status == 'completed' %}
                        <a href="{{ url_for('download_report', project_name=job.project_name) }}"
                            class="p-1.5 rounded hover:bg-Primary-100 transition" title="Download Report">
                            <i data-lucide="download" class="w-4 h-4 text-Primary-500"></i>
                        </a>
                        {% else %}
                        <button class="p-1.5 rounded bg-gray-100 cursor-not-allowed" title="Report not available yet"
                            disabled>
                            <i data-lucide="download" class="w-4 h-4 text-gray-400"></i>
                        </button>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% else %}
    <div class="text-center py-12 bg-white rounded-lg border border-gray-100">
        <i data-lucide="inbox" class="w-16 h-16 text-gray-300 mx-auto mb-4"></i>
        <p class="text-gray-500 mb-4">No projects yet. Start your first pentest!</p>
        <a href="{{ url_for('scan_vulnerability') }}"
            class="inline-flex items-center gap-2 bg-Primary-500 text-white px-6 py-2 rounded-lg hover:bg-Primary-200 transition">
            <i data-lucide="plus-circle" class="w-4 h-4"></i> Create Project
        </a>
    </div>
    {% endif %}
</div>