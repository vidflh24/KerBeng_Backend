<div x-data="progressTable()">
  <div id="progress-table" x-init="lucide.createIcons()" data-jobs='{{ jobs | tojson | safe }}'
    hx-get="{{ url_for('htmx_progress_table') }}" hx-trigger="load, every 10s" hx-swap="morphdom:outerHTML"
    hx-target="#progress-table"> {% if jobs %}
    <div class="overflow-x-auto rounded-lg border border-gray-100">
      <table class="min-w-full table-fixed divide-y divide-gray-200 text-sm">
        <thead class="bg-Primary-100 text-Primary-500 uppercase text-xs font-semibold">
          <tr>
            <th class="px-4 py-3 text-left cursor-pointer select-none" hx-get="{{ url_for('htmx_progress_table') }}"
              hx-include="[name='progress_search']"
              hx-vals='{"sort_by":"target_ip","order":"{{ "asc" if sort_by != "target_ip" or order == "desc" else "desc" }}"}'
              hx-target="#progress-table" hx-swap="morphdom:outerHTML" onclick="
              const table = document.getElementById('progress-table');
              table.dataset.sortBy = 'project_name';
              table.dataset.order = '{{ 'asc' if sort_by != 'project_name' or order == 'desc' else 'desc' }}';">
              IP / Subnet
              {% if sort_by == "target_ip" %}
              {% if order == "asc" %}
              <i data-lucide="arrow-up" class="inline w-3 h-3 ml-1 text-Primary-500"></i>
              {% else %}
              <i data-lucide="arrow-down" class="inline w-3 h-3 ml-1 text-Primary-500"></i>
              {% endif %}
              {% else %}
              <i data-lucide="arrow-up-down" class="inline w-3 h-3 ml-1 opacity-60"></i>
              {% endif %}
            </th>

            <th class="px-4 py-3 text-left cursor-pointer select-none" hx-get="{{ url_for('htmx_progress_table') }}"
              hx-vals='{"sort_by":"project_name","order":"{{ "asc" if sort_by != "project_name" or order == "desc" else "desc" }}"}'
              hx-target="#progress-table" hx-swap="morphdom:outerHTML">
              Project Name
              {% if sort_by == "project_name" %}
              <i data-lucide="{{ 'arrow-up' if order == 'asc' else 'arrow-down' }}" class="inline w-3 h-3 ml-1"></i>
              {% else %}
              <i data-lucide="arrow-up-down" class="inline w-3 h-3 ml-1 opacity-60"></i>
              {% endif %}
            </th>

            <th class="px-4 py-3 text-left cursor-pointer select-none" hx-get="{{ url_for('htmx_progress_table') }}"
              hx-vals='{"sort_by":"status","order":"{{ "asc" if sort_by != "status" or order == "desc" else "desc" }}"}'
              hx-target="#progress-table" hx-swap="morphdom:outerHTML">
              Progress
              {% if sort_by == "status" %}
              <i data-lucide="{{ 'arrow-up' if order == 'asc' else 'arrow-down' }}" class="inline w-3 h-3 ml-1"></i>
              {% else %}
              <i data-lucide="arrow-up-down" class="inline w-3 h-3 ml-1 opacity-60"></i>
              {% endif %}
            </th>
          </tr>
        </thead>

        <tbody class="bg-white divide-y divide-gray-100 align-top">
          {% for job in jobs %}
          <tr class="hover:bg-Primary-100/30 transition-colors">
            <!-- IP/Subnet -->
            <td class="px-4 py-3 align-middle">
              <div class="font-mono text-sm text-gray-900">{{ job.target_ip }}</div>
              <div class="text-xs text-gray-500 mt-1 flex items-center gap-1">
                <i data-lucide="shield" class="w-3 h-3"></i>
                {{ job.cve_module }}
              </div>
            </td>

            <!-- Project Name -->
            <td class="px-4 py-3 align-middle">
              <div class="font-medium text-gray-900">{{ job.project_name }}</div>
              <div class="text-xs text-gray-500 mt-1">
                {% if job.status == 'queued' %}
                <span class="inline-flex items-center gap-1">
                  <i data-lucide="clock" class="w-3 h-3"></i>
                  Queued (Position: {{ job.queue_position or '?' }})
                </span>
                {% else %}
                Started: {{ job.started_at or 'N/A' }}
                {% endif %}
              </div>
            </td>

            <!-- Status -->
            <td class="px-4 py-3 whitespace-nowrap align-middle">
              {% if job.status == 'queued' %}
              <div class="flex items-center gap-2">
                <div class="w-40 bg-gray-200 h-2 rounded-full overflow-hidden">
                  <div class="bg-yellow-500 h-2" style="width: 0%"></div>
                </div>
                <span class="inline-flex items-center text-yellow-600 text-sm font-medium">
                  <i data-lucide="clock" class="w-4 h-4 mr-1"></i>Queued
                </span>
              </div>
              <div class="mt-2">
                <!-- Tombol Remove Queue -->
                <button class="text-gray-600 hover:text-gray-800 text-xs flex items-center gap-1 transition-colors"
                  hx-get="/partials/confirm-remove-modal" hx-target="body" hx-swap="beforeend"
                  hx-vals='{"job_id": "{{ job.job_id }}", "project_name": "{{ job.project_name }}"}'>
                  <i data-lucide="trash-2" class="w-3 h-3"></i>
                  Remove Queue
                </button>
              </div>
              {% elif job.status == 'running' %}
              <div class="flex items-center gap-2">
                <div class="w-40 bg-gray-200 h-2 rounded-full overflow-hidden">
                  <div class="bg-blue-500 h-2 transition-all duration-500" style="width: {{ job.progress or 0 }}%">
                  </div>
                </div>
                <span class="inline-flex items-center text-blue-600 text-sm font-medium">
                  <i data-lucide="loader-2" class="w-4 h-4 animate-spin mr-1"></i>
                  {{ job.progress or 0 }}%
                </span>
              </div>
              <div class="mt-2">
                <!-- Tombol Cancel Job -->
                <button class="text-red-600 hover:text-red-800 text-xs flex items-center gap-1 transition-colors"
                  hx-get="/partials/confirm-cancel-modal" hx-target="body" hx-swap="beforeend"
                  hx-vals='{"job_id": "{{ job.job_id }}", "project_name": "{{ job.project_name }}"}'
                  hx-on::before-request="window.stopAutoRefresh && window.stopAutoRefresh()">
                  <i data-lucide="x-circle" class="w-3 h-3"></i>
                  Cancel Job
                </button>
              </div>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% else %}
    <div class="text-center py-8 text-gray-500 bg-white rounded-lg border border-gray-100">
      <i data-lucide="clock" class="w-12 h-12 text-gray-300 mx-auto mb-3"></i>
      <p class="font-medium">No running pentests at the moment</p>
      <p class="text-sm mt-1">Start a new project to see real-time progress here</p>
      <a href="{{ url_for('scan_vulnerability') }}"
        class="inline-flex items-center gap-2 mt-4 bg-Primary-500 text-white px-4 py-2 rounded-lg hover:bg-Primary-200 transition">
        <i data-lucide="play" class="w-4 h-4"></i>Start Pentest
      </a>
    </div>
    {% endif %}
  </div>
</div>
<script>
  function progressTable() {
    return {
      // ambil data dari backend
      projects: JSON.parse(document.querySelector('[x-data="progressTable()"]').getAttribute('data-jobs') || '[]'),
      search: "",
      currentPage: 1,
      perPage: 5,
      sortColumn: 'project_name',
      sortDirection: 'asc',

      showConfirm: false,
      selectedJobId: null,
      selectedJobName: '',

      sort(column) {
        if (this.sortColumn === column) {
          this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          this.sortColumn = column;
          this.sortDirection = 'asc';
        }
      },


      get filteredProjects() {
        return this.projects.filter(p =>
          p.project_name.toLowerCase().includes(this.search.toLowerCase())
        );
      },

      get totalFilteredCount() {
        return this.filteredProjects.length;
      },

      get totalPages() {
        return Math.ceil(this.totalFilteredCount / this.perPage);
      },

      get sortedProjects() {
        const sorted = [...this.filteredProjects];
        sorted.sort((a, b) => {
          let valA = a[this.sortColumn];
          let valB = b[this.sortColumn];
          if (typeof valA === "string") valA = valA.toLowerCase();
          if (typeof valB === "string") valB = valB.toLowerCase();
          if (valA < valB) return this.sortDirection === "asc" ? -1 : 1;
          if (valA > valB) return this.sortDirection === "asc" ? 1 : -1;
          return 0;
        });
        return sorted;
      },

      get visiblePages() {
        const windowSize = 3;
        const start = Math.max(1, this.currentPage - Math.floor(windowSize / 2));
        const end = Math.min(this.totalPages, start + windowSize - 1);
        const pages = [];
        for (let i = start; i <= end; i++) pages.push(i);
        return pages;
      },

      nextPage() { if (this.currentPage < this.totalPages) this.currentPage++; },
      prevPage() { if (this.currentPage > 1) this.currentPage--; },
      goToPage(page) { this.currentPage = page; },
    };
  }
  document.body.addEventListener('htmx:configRequest', (evt) => {
    const progressTable = document.getElementById('progress-table');
    if (evt.detail.path.includes('htmx_progress_table') && progressTable) {
      evt.detail.parameters.sort_by = progressTable.dataset.sortBy || 'created_at';
      evt.detail.parameters.order = progressTable.dataset.order || 'desc';
    }
  });
  document.body.addEventListener("htmx:beforeSwap", (evt) => {
    const modal = document.querySelector('[x-show="showConfirm"]');
    if (modal && modal.__x && modal.__x.$data.showConfirm) {
      if (evt.detail.target.id === "progress-table") {
        evt.detail.shouldSwap = false;
      }
    }
  });

  document.addEventListener("htmx:afterSwap", () => {
    lucide.createIcons();
    if (window.Alpine) {
      Alpine.flushAndStopDeferringMutations();
      Alpine.initTree(document.body);
    }
  });
  document.addEventListener("DOMContentLoaded", () => lucide.createIcons());

</script>